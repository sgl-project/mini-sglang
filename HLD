Overall 

                    ┌──────────────────────────────────────┐
                    │                        │
                    │                                      │
                    │  server/     → HTTP & Process mgmt   │
                    │  tokenizer/  → Text ↔ Tokens         │
                    │  core.py     → Data structures       │
                    │                                      │
                    └──────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        NEXT LAYER (Core Logic)                          │
│                                                                         │
│   ┌─────────────┐    ┌─────────────────┐    ┌─────────────────────┐    │
│   │ message.py  │───►│  scheduler.py   │───►│     engine.py       │    │
│   │             │    │                 │    │                     │    │
│   │ ZMQ message │    │ THE BRAIN ⭐    │    │ Forward pass        │    │
│   │ types       │    │ Batching        │    │ CUDA graphs         │    │
│   │             │    │ Memory mgmt     │    │                     │    │
│   └─────────────┘    └─────────────────┘    └─────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        DEEP LAYER (Model & Infra)                       │
│                                                                         │
│   ┌─────────────┐    ┌─────────────────┐    ┌─────────────────────┐    │
│   │  models/    │    │   attention/    │    │     kvcache/        │    │
│   │             │    │                 │    │                     │    │
│   │ Llama/Qwen  │    │ FlashAttention  │    │ Radix cache         │    │
│   │ architecture│    │ FlashInfer      │    │ Memory pool         │    │
│   └─────────────┘    └─────────────────┘    └─────────────────────┘    │
│                                                                         │
│   ┌─────────────┐    ┌─────────────────┐                               │
│   │  layers/    │    │  distributed.py │                               │
│   │             │    │                 │                               │
│   │ TP-aware    │    │ NCCL wrappers   │                               │
│   │ Linear/Emb  │    │ all_reduce      │                               │
│   └─────────────┘    └─────────────────┘                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘



Schedular 

┌─────────────────────────────────────────────────────────────────────────────┐
│                            SCHEDULER                                         │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     SchedulerIOMixin (io.py)                        │    │
│  │  • receive_msg() - from Tokenizer (+ broadcast to other TP ranks)   │    │
│  │  • send_result() - to Detokenizer                                   │    │
│  │  • sync_all_ranks() - NCCL barrier                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    ▼                                         │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐       │
│  │  PrefillManager  │    │  DecodeManager   │    │   CacheManager   │       │
│  │   (prefill.py)   │    │   (decode.py)    │    │    (cache.py)    │       │
│  │                  │    │                  │    │                  │       │
│  │  pending_list    │    │  running_reqs    │    │  _free_slots     │       │
│  │  (waiting queue) │───►│  (active reqs)   │    │  (memory pool)   │       │
│  └──────────────────┘    └──────────────────┘    └──────────────────┘       │
│           │                       │                       │                  │
│           │                       │                       │                  │
│           ▼                       ▼                       ▼                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      TableManager (table.py)                        │    │
│  │  • page_table: maps request slots to KV cache pages                 │    │
│  │  • token_pool: stores token IDs for each request                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Engine (engine.py)                          │    │
│  │  • forward_batch() - run model forward pass                         │    │
│  │  • CUDA graphs for decode                                           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
